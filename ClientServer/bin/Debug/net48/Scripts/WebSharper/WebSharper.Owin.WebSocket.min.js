(function(){"use strict";var a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t;a=self;b=a.WebSharper=a.WebSharper||{};c=b.Owin=b.Owin||{};d=c.WebSocket=c.WebSocket||{};e=d.JsonEncoding=d.JsonEncoding||{};f=d.Async=d.Async||{};g=d.Endpoint=d.Endpoint||{};h=d.Client=d.Client||{};i=h.Message=h.Message||{};j=b&&b.Obj;k=h.WebSocketServer=h.WebSocketServer||{};l=h.WithEncoding=h.WithEncoding||{};m=a.IntelliFactory;n=m&&m.Runtime;o=b&&b.Control;p=o&&o.MailboxProcessor;q=b&&b.Concurrency;r=a.JSON;s=b&&b.Json;t=b&&b.Seq;e=d.JsonEncoding=n.Class({ClientProviderOrElse:function(u){return this.$==1?u:u;}},null,e);e.Readable=new e({$:1});e.Typed=new e({$:0});f.FoldAgent=function(u,v){return p.Start(function(w){function x(y){var z;z=null;return q.Delay(function(){return q.Bind(w.Receive(null),function(A){return q.Bind(v(y,A),function(B){return x(B);});});});}return x(u);},null);};g.CreateRemote=function(u,v){return g.New(u,"",v==null?e.Typed:v.$0);};g.New=function(u,v,w){return{URI:u,Route:v,JsonEncoding:w};};i.Close={$:3};i.Open={$:2};i.Error={$:1};k=h.WebSocketServer=n.Class({Post:function(u){this.conn.send(this.encode(u));},get_Connection:function(){return this.conn;}},j,k);k.New=n.Ctor(function(u,v){j.New.call(this);this.conn=u;this.encode=v;},k);l.Connect=function(u,v,w,x){return l.FromWebSocket(u,v,new a.WebSocket(w.URI),x,w.JsonEncoding);};l.ConnectStateful=function(u,v,w,x){return l.FromWebSocketStateful(u,v,new a.WebSocket(w.URI),x,w.JsonEncoding);};l.FromWebSocket=function(u,v,w,x,y){var z,A,B,C,D,E,F,G,H;function I(J){return r.parse(J);}z=(A=y.$==0?[function(J){return r.stringify(J);},function(J){return s.Activate(I(J));}]:[u,v],(B=A[1],[A[0],function(J){return B(J.data);}]));C=z[1];D=(E=[],(F=[false],(w.onopen=function(){E.push(i.Open);F[0]=true;},w.onclose=function(){return E.push(i.Close);},w.onmessage=function(J){return E.push({$:0,$0:C(J)});},w.onerror=function(){return E.push(i.Error);},function(J){t.iter(J,E);return F[0];})));G=new k.New(w,z[0]);H=null;return q.Delay(function(){return q.Bind(x(G),function(J){function K(L,M){var N;N=D(J);w.onopen=function(){J(i.Open);return L(G);};w.onclose=function(){return J(i.Close);};w.onmessage=function(O){return J({$:0,$0:C(O)});};w.onerror=function(){J(i.Error);return M(new a.Error("Could not connect to the server."));};N?L(G):void 0;}return q.FromContinuations(function(L,M,N){return K.apply(null,[L,M,N]);});});});};l.FromWebSocketStateful=function(u,v,w,x,y){var z,A,B,C,D,E,F,G,H;function I(J){return r.parse(J);}z=(A=y.$==0?[function(J){return r.stringify(J);},function(J){return s.Activate(I(J));}]:[u,v],(B=A[1],[A[0],function(J){return B(J.data);}]));C=z[1];D=(E=[],(F=[false],(w.onopen=function(){E.push(i.Open);F[0]=true;},w.onclose=function(){return E.push(i.Close);},w.onmessage=function(J){return E.push({$:0,$0:C(J)});},w.onerror=function(){return E.push(i.Error);},function(J){t.iter(J,E);return F[0];})));G=new k.New(w,z[0]);H=null;return q.Delay(function(){return q.Bind(x(G),function(J){var K,L;function M(N,O){var P;P=D(function(Q){L.mailbox.AddLast(Q);L.resume();});w.onopen=function(){L.mailbox.AddLast(i.Open);L.resume();return N(G);};w.onclose=function(){L.mailbox.AddLast(i.Close);return L.resume();};w.onmessage=function(Q){L.mailbox.AddLast({$:0,$0:C(Q)});return L.resume();};w.onerror=function(){L.mailbox.AddLast(i.Error);L.resume();return O(new a.Error("Could not connect to the server."));};P?N(G):void 0;}K=J[1];L=f.FoldAgent(J[0],function(N,O){return(K(N))(O);});return q.FromContinuations(function(N,O,P){return M.apply(null,[N,O,P]);});});});};}());
